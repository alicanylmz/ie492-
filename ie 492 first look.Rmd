---
title: "IE 492 MCP First Look"
author: "Alican YÄ±lmaz"
date: "3/29/2021"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
 #setwd("/Users/Alican/Documents/Github/ie492-/Datasets")

```

## R Markdown

```{r READ, warning=FALSE, message=FALSE}
library('ggplot2')
library('forecast')
library('tseries')
library("data.table")
library("lubridate")
library("zoo")
library("plotly")
```


```{r}

mcp_raw = fread('MCP-01012017-29032021.csv', header=TRUE)
mcp_raw[,Date:=as.Date(Date,"%d/%m/%Y")]
```


```{r}
daily_MCP=mcp_raw[,list(daily_MCP=mean(`MCP (TL/MWh)`,na.rm=T)),by=list(Date)]
```

```{r}
plt<-ggplot(daily_MCP, aes(Date, daily_MCP)) + geom_line()  + labs(x="Date",y="MCP TL/Mwh)",title="Daily Mean mcp")

ggplotly(plt)
```

Variance not constant, there is trend for sure. Also, outliers exist. Transformation is necessary?

Currency also has an effect maybe? (2018 Currency crisis)

```{r acf/pacf}

ggAcf(daily_MCP$daily_MCP, lag=48)


```


Seasonality at weekly level.



```{r}
# Plotting a portion of daily data
ggplot(data = daily_MCP[1:28], aes(x = Date, y =daily_MCP )) +
  geom_line(color = "darkred") +
  labs(title = "Daily MCP(01.01.2017-28.01.2017) ",
       x = "Date",
       y= "MCP TL/(MWh)") +
  scale_x_date(date_minor_breaks = "1 day", date_breaks = "2 days", date_labels = "%d %b") +
  theme_minimal()
```




```{r}
plt<-ggplot(data = mcp_raw[1:96], aes(x = index(mcp_raw[1:96]), y = `MCP (TL/MWh)` )) +
  geom_line(color = "darkred") +
  labs(title = "Hourly MCP(01.01.2017-04.01.2017) ",
       x = "Date",
       y= "MCP TL/(MWh)") +
  theme_minimal()
ggplotly(plt)
```


There seems to be a seasonality at hourly level.

```{r ACF/PACF}
ggAcf(mcp_raw$`MCP (TL/MWh)`, lag=72)

```

Daily seasonality.

Weekends & holidays might affect.(But weekends might be redundant if weekly seasonality is put as input.)
Electricity Demand
Electricity Load
Temperature
Available capacity
Codes of Days
Supply & Demand of Electricity(Only shows one hour. How to download all?)
Weather conditions & Fuel Prices

```{r Data manipulation weekend and day code is added}
mcp_raw$day <- weekdays(as.Date(mcp_raw$Date))
mcp_raw$IsWeekend <- mcp_raw$day %in% c("Saturday","Sunday")
mcp_raw<-transform(mcp_raw ,IsWeekend = ifelse(mcp_raw$day %in% c("Saturday","Sunday") ,1,0 ))

```


# Web Scraping For Fuel Prices

```{r Fuel Prices in Turkey}
#install.packages("rvest")
#install.packages("dplyr")
library(rvest)
library(dplyr)
```


```{r}
link="https://www.tppd.com.tr/en/former-oil-prices?id=34&county=413&StartDate=01.01.2017&EndDate=29.03.2021"
page=read_html(link)

date<-page %>% html_nodes("td:nth-child(1)") %>% html_text()
fuel_price<-as.numeric(page %>% html_nodes("td:nth-child(6)") %>% html_text())
fuel_price_df<-data.frame(date,fuel_price,stringsAsFactors = FALSE)
fuel_price_df$date<-as.Date(fuel_price_df$date, format =  "%d %B %Y")
```


Some of the days are missing. We could interpolate them

```{r interpolating missing values of fuel prices}

ApproxFun <- approxfun(x = fuel_price_df$date, y = fuel_price_df$fuel_price)
Dates<-seq.Date(ymd("2017-01-01"),ymd("2021-04-09"),by=1)
LinearFit <- ApproxFun(Dates)


full_fuel_price_df<-data.frame(Date = Dates, fUEL_pRICE = LinearFit)

full_fuel_price_df<-full_fuel_price_df[full_fuel_price_df$Date<"2021-03-30",]

```




## ARIMA: Benchmark Purposes

Box-Jenkins Methodology will be used:

```{r}
adf.test(mcp_raw$`MCP (TL/MWh)`)
```

Data is stationary at 0.01 significance level.

```{r}
ggAcf(mcp_raw$`MCP (TL/MWh)`,lag.max = 168)
```

```{r}
ggPacf(mcp_raw$`MCP (TL/MWh)`,lag.max = 168)

```



```{r}
BoxCox.lambda(daily_MCP$`MCP (TL/MWh)`)
```

Lambda is close to 1, so no need transformation.






We know that there is weekly seasonality from the daily plot.

```{r}
daily_mcp_ts<-ts(daily_MCP$daily_MCP,frequency = 7)
fitted<-auto.arima(daily_mcp_ts,seasonal=TRUE,trace = TRUE)
checkresiduals(fitted)
```


```{r}
daily_mcp_ts<-ts(daily_MCP$daily_MCP,frequency = 7)
fitted<-arima(daily_mcp_ts,order=c(1,1,1),seasonal=c(2,0,0))
ggtsdisplay(fitted$residuals)
checkresiduals(fitted)
library(lmtest)
coeftest(fitted)
```

Model each hour separately for benchmark purpose.



## MAPE 

For one week:

Train: 2017-2020
Test: 3 Week

```{r}
# Error test
```

## DATA COLLECTING & RELATIONSHIP TESTING

HYPOTHESIS: ELECTRICITY DEMAND SIGNIFICANTLY AFFECTS MCP

### Getting Electricity Demand Data

```{r}

electricity_demand_df<-fread('RealTimeConsumption-01012017-12042021.csv', header=TRUE)
electricity_demand_df[,Date:=as.Date(Date,"%d.%m.%Y")]
electricity_demand_df[,`Consumption (MWh)`:=as.numeric(gsub(",", "", `Consumption (MWh)`))]
electricity_demand_df<-electricity_demand_df[Date<="2021-03-29",]

```



```{r creating data_frame includes all variables}
whole_Data<-mcp_raw
whole_Data$electricity_consumption<-electricity_demand_df$`Consumption (MWh)`
```

### Plotting Demand vs Price Relationship

```{r}
ggplot(whole_Data[Date<="2017-06-01",],aes(x=electricity_consumption, y =`MCP (TL/MWh)`))+
geom_point()+geom_smooth(method=lm)
```



Plotting at daily level, for each hour separately:

```{r}
ggplot(whole_Data,aes(x=electricity_consumption, y =`MCP (TL/MWh)`))+
geom_point()+geom_smooth(method=lm)+
  facet_wrap(vars(Hour))
```

### Regression Model for Electricity Demand



```{r}
lmMCP = lm(`MCP (TL/MWh)`~electricity_consumption, data = whole_Data) #Create the linear regression
summary(lmMCP) #Review the results
```

we can say that electricity consumption is statistically significant.However, R-square is quite low, meaning that variance can not be explained simply by consumption.

```{r}
ggtsdisplay(lmMCP$residuals)
```


This allows you to polynomial regression model of degree 3 of x


```{r}
#model <- lm(y ~ poly(x,3))
```


### Fuel_Prices vs MCP


```{r}
whole_Data_daily<-whole_Data %>%
  group_by(Date)
whole_Data_daily<-whole_Data_daily%>% summarise(
  mcp=mean(`MCP (TL/MWh)`))
whole_Data_daily$fuelprice<-full_fuel_price_df$fUEL_pRICE  

```



```{r}
whole_Data_daily%>%
  ggplot(.,aes(x=fuelprice,y=mcp))+
  geom_point()+geom_smooth(method=lm)
```

### Regression Model for Electricity Demand



```{r}
lmMCP = lm(mcp~fuelprice, data = whole_Data_daily) #Create the linear regression
summary(lmMCP) #Review the results
```

Statistically significant. But R^2 could be improved still.

## Hydro Production Analysis

Hypothesis: Real Time Hydro Production has an effect on MCP

### Getting Data


```{r}
production = fread('RealTimeGeneration-01012017-14032021.csv', header=TRUE)
production[,Date:=as.Date(Date,"%d.%m.%Y")]
production[,3:18] <- lapply(production[,3:18], function(x) as.numeric(gsub(",", "", x)))

```


```{r}
df<-whole_Data[Date<="2021-03-13",]
df$Dammed_Hydro_pr<-production[Date<="2021-03-13",`Dammed Hydro`]
```



```{r}
df%>%
  ggplot(.,aes(x=Dammed_Hydro_pr,y=`MCP (TL/MWh)`))+
  geom_point()+geom_smooth(method=lm)
```


```{r}
df%>%
  ggplot(.,aes(x=Dammed_Hydro_pr,y=`MCP (TL/MWh)`))+
  geom_point()+geom_smooth(method=lm) +facet_wrap(vars(Hour))
```


It is hard to tell the effect of dammed hydro production on MCP as it is hour dependent.

```{r}
lmMCP = lm(`MCP (TL/MWh)`~Dammed_Hydro_pr, data = df) #Create the linear regression
summary(lmMCP) #Review the results
```

R^2 is almost zero. 



## Bilateral Contracts

Hypothesis: Bilateral Contracts Total Bid Quantity has an effect on price.

```{r}
Bilateral_df = fread('BilateralContractsBid-01012017-29032021.csv', header=TRUE)
Bilateral_df[,Date:=as.Date(Date,"%d/%m/%Y")]
Bilateral_df[,3] <- lapply(Bilateral_df[,3], function(x) as.numeric(gsub(",", "", x)))
```

```{r}
whole_Data$'bilateral(MWh)'<-Bilateral_df[,3]


whole_Data[Date>="2020-01-01",]%>%
  ggplot(.,aes(x=`bilateral(MWh)`,y=`MCP (TL/MWh)`))+
  geom_point()+geom_smooth(method=lm)


```




```{r}
lmMCP = lm(`MCP (TL/MWh)`~`bilateral(MWh)`, data = whole_Data[Date>="2020-01-01",]) #Create the linear regression
summary(lmMCP) #Review the results
```

# Corrplot

```{r}
library(corrplot)

M<-cor(whole_Data[,c(3,8)])

corrplot(M, method="number")
```

## Installed Capacity vs MCP

```{r}
capacity=fread("EAK-01012017-29032021.csv",header=TRUE)
capacity[,Date:=as.Date(Date,"%d.%m.%Y")]

capacity[,`Total (MWh)`:=as.numeric(gsub(",", "",`Total (MWh)`))]
head(capacity)
  
```


```{r}
whole_Data$InstalledCapacity<-capacity$`Total (MWh)`
head(whole_Data)
```

```{r}
whole_Data%>%
  ggplot(.,aes(x=InstalledCapacity,y=`MCP (TL/MWh)`))+
  geom_point()+geom_smooth(method=lm) #+facet_wrap(vars(Hour))
```


```{r}
whole_Data %>%
  group_by(Date)%>%
  summarise(
    daily_MCP = sum(`MCP (TL/MWh)`),
  daily_capacity = sum(InstalledCapacity))%>%
  ggplot(.,aes(x=daily_capacity,y=daily_MCP))+
  geom_point()+geom_smooth(method=lm)
```






## Agraggate Daily Data





## Daily Mean Electricity Consumption Data


```{r}
daily_whole_data<-whole_Data %>% 
  group_by(Date) %>% 
  summarise(across(where(is.numeric), list(mean = mean, sum = sum)))
```

```{r}
model <- lm(`MCP (TL/MWh)_sum` ~ poly(InstalledCapacity_sum,3),data=daily_whole_data)
summary(model)
plot(fitted(model),residuals(model))
```
## Outlier Analysis



```{r}
daily_whole_data%>%
  ggplot(.,aes(x=Date,y=`MCP (TL/MWh)_mean`))+
  geom_line(color = "darkred") +
  labs(title = "Daily MCP",
       x = "Date",
       y= "MCP TL/(MWh)") +
  theme_minimal()
```

## Daily Hydro Production

```{r}
df_aggregated<-df%>% 
  group_by(Date) %>% 
  summarise(across(where(is.numeric), list(mean = mean, sum = sum)))
df_aggregated
```

```{r}
df_aggregated%>%ggplot(.,aes(x=`Dammed_Hydro_pr_sum`,y=`MCP (TL/MWh)_sum`))+
  geom_point()+geom_smooth(method=lm)
```



```{r}
a<-ts(df_aggregated$`MCP (TL/MWh)_mean`)
b<-ts(ts(df_aggregated$Dammed_Hydro_pr_mean))

autoplot(cbind(a,b),facets=TRUE)
```


```{r}
library(corrplot)

M<-cor(df_aggregated[,c(2,10)])

corrplot(M, method="number")
```



```{r}
df_hydro<-df_aggregated[,c("MCP (TL/MWh)_mean","Dammed_Hydro_pr_mean","MCP (TL/MWh)_sum","Dammed_Hydro_pr_sum")]


```


```{r}
Q <- quantile(df_hydro$Dammed_Hydro_pr_mean, probs=c(.25, .75), na.rm = FALSE)
Q
```


```{r}
eliminated<- subset(df_hydro, df_hydro$Dammed_Hydro_pr_mean < (Q[1]) | df_hydro$Dammed_Hydro_pr_mean > (Q[2]))
eliminated
```

```{r}
#eliminated %>% ggplot(.,aes(x=`Dammed_Hydro_pr_mean`,y=`MCP (TL/MWh)_mean`))+
#  geom_point()+geom_smooth(method=lm)
```



## Planned Production vs Planned Load

```{r}

planned_prod = fread('Final+Daily+Production+Program-01012017-29032021.csv', header=TRUE)
planned_prod[,Date:=as.Date(Date,"%d.%m.%Y")]
planned_prod[,c("Date","Hour",`Total (MWh)`)]
planned_load=fread('LoadForecast-01012017-29032021.csv', header=TRUE)
planned_load[,Date:=as.Date(Date,"%d/%m/%Y")]
new_df_prod_load<-merge.data.frame(planned_load,planned_prod,by=c("Date","Hour"))
new_df_prod_load<-data.table(new_df_prod_load)
new_df_prod_load[,`Load Forecast (MWh)`:=as.numeric(gsub(",", "", `Load Forecast (MWh)`))]
new_df_prod_load[,`Total (MWh)`:=as.numeric(gsub(",", "", `Total (MWh)`))]
new_df_prod_load$ratio<-new_df_prod_load$`Load Forecast (MWh)`/new_df_prod_load$`Total (MWh)`
```


```{r}

df_comb<-merge(new_df_prod_load[,c(1,2,17)],mcp_raw[,c(1:3)],by=c("Date","Hour"))

df_comb %>% ggplot(.,aes(x=`MCP (TL/MWh)`,y=ratio))+
  geom_point()
```

```{r}
library(tidyverse)
df_comb %>%
  mutate(pct_change = (lead(ratio)/ratio - 1) * 100)%>% ggplot(.,aes(x=`MCP (TL/MWh)`,y=pct_change))+
  geom_point()
```

# Wind ratio & Hydro ratio analysis

```{r}
mcp_raw<-mcp_raw[Date<="2021-03-13",]
production<-production[Date<="2021-03-13",c("Date","Hour","Total (MWh)","Dammed Hydro","Wind")]
merged_data<-merge(mcp_raw,production,by =c("Date","Hour"))
merged_data<-merged_data %>%
  mutate(pct_wind = (Wind/`Total (MWh)`) * 100, pct_dammed_hydro=(`Dammed Hydro`/`Total (MWh)`) * 100)
```


```{r}
merged_data2<-merged_data[Date>="2021-02-20",]

autoplot(cbind(ts(merged_data2$`MCP (TL/MWh)`),ts(merged_data2$pct_dammed_hydro)),facets=TRUE)
```

```{r}
library(corrplot)

M<-cor(merged_data[,c(3,9,12)])

corrplot(M, method="number")
```




### Differencing

```{r}

merged_data<-merged_data%>%
  mutate(diff_perc_hydro=c(NA,diff(pct_dammed_hydro)),diff_perc_wind=c(NA,diff(pct_dammed_hydro)),diff_MCP=c(NA,diff(`MCP (TL/MWh)`)))

cor(merged_data$diff_MCP,merged_data$diff_perc_hydro, use="complete.obs")
```


```{r}
merged_data3<-merged_data[Date>="2021-02-20",]

autoplot(cbind(ts(merged_data3$diff_MCP),ts(merged_data3$diff_perc_wind),ts(merged_data3$diff_perc_hydro)),facets=TRUE)
```

## Percentage of Renewable

## Granger test of causality
 First, be sure that both are stationary. Order(lag) is important!
 
```{r}
library(lmtest)
grangertest(merged_data$`MCP (TL/MWh)`~merged_data$pct_dammed_hydro, order=1)
```

```{r}
#install.packages("vars")
library(vars)
causal_df<-cbind(merged_data$pct_dammed_hydro,merged_data$`MCP (TL/MWh)`)
causal_car<-VAR(causal_df,type="const", lag.max=10 , ic = "AIC")
causality(causal_car,cause="y1")$Granger
```

## Wind percentage effect

```{r}
merged_data3<-merged_data[Date>="2021-02-20",]

autoplot(cbind(ts(merged_data3$`MCP (TL/MWh)`),ts(merged_data3$pct_wind)),facets=TRUE)
```


```{r}
merged_data4<-merged_data[Date<="2021-01-20" & Date>="2020-01-16",]

autoplot(cbind(ts(merged_data4$`MCP (TL/MWh)`),ts(merged_data4$pct_wind),ts(merged_data4$pct_dammed_hydro)),facets=TRUE)
```

```{r}
library(vars)
causal_df<-cbind(merged_data$pct_wind,merged_data$`MCP (TL/MWh)`)
causal_car<-VAR(causal_df,type="const", lag.max=10 , ic = "AIC")
causality(causal_car,cause="y2")$Granger
```


```{r}
merged_all = fread('merged.csv', header=TRUE)
merged_all[,Date:=as.Date(Date,"%d-%m-%Y")]
```

# NATURAL GAS PROPORTION

```{r}
merged_data4<-merged_all[Date<="2017-06-20" & Date>="2017-06-15",] 

autoplot(cbind(ts(merged_data4$MCP..TL.MWh.),ts(merged_data4$GProportion.NatGas),ts(merged_data4$GProportion.Wind),ts(merged_data4$GProportion.DammedH),ts(merged_data4$GProportion.Lignite),ts(merged_data4$GProportion.ImportC)),facets=TRUE)
```

## Renewable proportion analysis

```{r}
merged_all<-merged_all%>%
  mutate(pct_renewable = (GProportion.DammedH+GProportion.Biomass+GProportion.Geot+GProportion.River+GProportion.Solar))
```


```{r}
merged_data4<-merged_all[Date<="2018-06-20" & Date>="2018-05-15",] 

autoplot(cbind(ts(merged_data4$MCP..TL.MWh.),ts(merged_data4$pct_renewable)),facets=TRUE)
```



```{r}
cor(merged_all$MCP..TL.MWh.,merged_all$pct_renewable,use = "pairwise.complete.obs", method = c("pearson"))
```

```{r}
M<-cor(merged_all[,c("MCP..TL.MWh.","pct_renewable")],use ="pairwise.complete.obs",method="pearson" )

corrplot(M, method="number")
```

